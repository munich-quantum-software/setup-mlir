name: Build Portable MLIR Toolchain (staged)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "llvm-project ref or tag (e.g., llvmorg-21.1.0)"
        required: true
        default: "llvmorg-21.1.0"
      targets:
        description: "LLVM_TARGETS_TO_BUILD (e.g., X86;AArch64 or auto)"
        required: false
        default: "auto"
      cpu_flags:
        description: "Extra CPU flags (optional)"
        required: false
        default: ""
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  REF: ${{ github.event.inputs.ref || 'llvmorg-21.1.0' }}
  TARGETS: ${{ github.event.inputs.targets || 'auto' }}
  CPU_FLAGS: ${{ github.event.inputs.cpu_flags || '' }}

jobs:
  linux-stage0:
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-24.04
            short: linux
          - runner: ubuntu-24.04-arm
            short: linux-arm
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-${{ matrix.short }}-${{ env.REF }}-${{ github.ref_name }}
          restore-keys: |
            ccache-${{ matrix.short }}-${{ env.REF }}-
            ccache-${{ matrix.short }}-
      - name: Build Stage0 (Linux)
        run: scripts/toolchain/linux/build.sh "$REF" "$GITHUB_WORKSPACE/llvm-install" "$TARGETS"
        env:
          TOOLCHAIN_STAGE_FROM: 0
          TOOLCHAIN_STAGE_TO: 0
          TOOLCHAIN_CPU_FLAGS: ${{ env.CPU_FLAGS }}
      - name: Upload stage0-install
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.short }}-stage0-install
          path: stage0-install
          if-no-files-found: error

  linux-stage1:
    needs: linux-stage0
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-24.04
            short: linux
          - runner: ubuntu-24.04-arm
            short: linux-arm
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-${{ matrix.short }}-${{ env.REF }}-${{ github.ref_name }}
          restore-keys: |
            ccache-${{ matrix.short }}-${{ env.REF }}-
            ccache-${{ matrix.short }}-
      - name: Download stage0-install
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.short }}-stage0-install
          path: stage0-install
      - name: Build Stage1 (Linux)
        run: scripts/toolchain/linux/build.sh "$REF" "$GITHUB_WORKSPACE/llvm-install" "$TARGETS"
        env:
          TOOLCHAIN_STAGE_FROM: 1
          TOOLCHAIN_STAGE_TO: 1
          TOOLCHAIN_CPU_FLAGS: ${{ env.CPU_FLAGS }}
      - name: Upload pgoprof and stage1-install
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.short }}-stage1-outputs
          path: |
            pgoprof
            stage1-install
          if-no-files-found: error

  linux-stage2:
    needs: linux-stage1
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-24.04
            short: linux
          - runner: ubuntu-24.04-arm
            short: linux-arm
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-${{ matrix.short }}-${{ env.REF }}-${{ github.ref_name }}
          restore-keys: |
            ccache-${{ matrix.short }}-${{ env.REF }}-
            ccache-${{ matrix.short }}-
      - name: Download stage0-install
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.short }}-stage0-install
          path: stage0-install
      - name: Download stage1 outputs
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.short }}-stage1-outputs
          path: .
      - name: Build Stage2 (Linux)
        run: scripts/toolchain/linux/build.sh "$REF" "$GITHUB_WORKSPACE/llvm-install" "$TARGETS"
        env:
          TOOLCHAIN_STAGE_FROM: 2
          TOOLCHAIN_STAGE_TO: 2
          TOOLCHAIN_CPU_FLAGS: ${{ env.CPU_FLAGS }}
      - name: Upload Linux final artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.short }}-final-archive
          path: llvm-install/*.tar.zst
          if-no-files-found: error

  macos-stage0:
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-14
            short: macos
          - runner: macos-15-intel
            short: macos-intel
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ matrix.short }}-${{ env.REF }}-${{ github.ref_name }}
          restore-keys: |
            ccache-${{ matrix.short }}-${{ env.REF }}-
            ccache-${{ matrix.short }}-
      - name: Build Stage0 (macOS)
        run: scripts/toolchain/macos/build.sh "$REF" "$GITHUB_WORKSPACE/llvm-install" "$TARGETS" "$CPU_FLAGS"
        env:
          TOOLCHAIN_STAGE_FROM: 0
          TOOLCHAIN_STAGE_TO: 0
      - name: Upload stage0-install
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.short }}-stage0-install
          path: stage0-install
          if-no-files-found: error

  macos-stage1:
    needs: macos-stage0
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-14
            short: macos
          - runner: macos-15-intel
            short: macos-intel
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ matrix.short }}-${{ env.REF }}-${{ github.ref_name }}
          restore-keys: |
            ccache-${{ matrix.short }}-${{ env.REF }}-
            ccache-${{ matrix.short }}-
      - name: Download stage0-install
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.short }}-stage0-install
          path: stage0-install
      - name: Build Stage1 (macOS)
        run: scripts/toolchain/macos/build.sh "$REF" "$GITHUB_WORKSPACE/llvm-install" "$TARGETS" "$CPU_FLAGS"
        env:
          TOOLCHAIN_STAGE_FROM: 1
          TOOLCHAIN_STAGE_TO: 1
      - name: Upload pgoprof and stage1-install
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.short }}-stage1-outputs
          path: |
            pgoprof
            stage1-install
          if-no-files-found: error

  macos-stage2:
    needs: macos-stage1
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-14
            short: macos
          - runner: macos-15-intel
            short: macos-intel
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ matrix.short }}-${{ env.REF }}-${{ github.ref_name }}
          restore-keys: |
            ccache-${{ matrix.short }}-${{ env.REF }}-
            ccache-${{ matrix.short }}-
      - name: Download stage0-install
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.short }}-stage0-install
          path: stage0-install
      - name: Download stage1 outputs
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.short }}-stage1-outputs
          path: .
      - name: Build Stage2 (macOS)
        run: scripts/toolchain/macos/build.sh "$REF" "$GITHUB_WORKSPACE/llvm-install" "$TARGETS" "$CPU_FLAGS"
        env:
          TOOLCHAIN_STAGE_FROM: 2
          TOOLCHAIN_STAGE_TO: 2
      - name: Upload macOS final artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.short }}-final-archive
          path: llvm-install/*.tar.zst
          if-no-files-found: error

  windows-stage0:
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: windows-2022
            short: windows
          - runner: windows-11-arm
            short: windows-arm
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - name: Install zstd
        run: choco install -y zstd
      - name: Build Stage0 (Windows)
        shell: bash
        run: scripts/toolchain/windows/build.sh "$REF" "$GITHUB_WORKSPACE/llvm-install" "$TARGETS" "$CPU_FLAGS"
        env:
          TOOLCHAIN_STAGE_FROM: 0
          TOOLCHAIN_STAGE_TO: 0
      - name: Upload stage0-install
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.short }}-stage0-install
          path: stage0-install
          if-no-files-found: error

  windows-stage1:
    needs: windows-stage0
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: windows-2022
            short: windows
          - runner: windows-11-arm
            short: windows-arm
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - name: Install zstd
        run: choco install -y zstd
      - name: Download stage0-install
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.short }}-stage0-install
          path: stage0-install
      - name: Build Stage1 (Windows)
        shell: bash
        run: scripts/toolchain/windows/build.sh "$REF" "$GITHUB_WORKSPACE/llvm-install" "$TARGETS" "$CPU_FLAGS"
        env:
          TOOLCHAIN_STAGE_FROM: 1
          TOOLCHAIN_STAGE_TO: 1
      - name: Upload pgoprof and stage1-install
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.short }}-stage1-outputs
          path: |
            pgoprof
            stage1-install
          if-no-files-found: error

  windows-stage2:
    needs: windows-stage1
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: windows-2022
            short: windows
          - runner: windows-11-arm
            short: windows-arm
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - name: Install zstd
        run: choco install -y zstd
      - name: Download stage0-install
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.short }}-stage0-install
          path: stage0-install
      - name: Download stage1 outputs
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.short }}-stage1-outputs
          path: .
      - name: Build Stage2 (Windows)
        shell: bash
        run: scripts/toolchain/windows/build.sh "$REF" "$GITHUB_WORKSPACE/llvm-install" "$TARGETS" "$CPU_FLAGS"
        env:
          TOOLCHAIN_STAGE_FROM: 2
          TOOLCHAIN_STAGE_TO: 2
      - name: Upload Windows final artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.short }}-final-archive
          path: llvm-install/*.tar.zst
          if-no-files-found: error
