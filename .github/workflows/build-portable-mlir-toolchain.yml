name: Build Portable MLIR Toolchain (staged)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "llvm-project ref or tag (e.g., llvmorg-21.1.0)"
        required: true
        default: "llvmorg-21.1.0"
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  linux:
    uses: ./.github/workflows/build-mlir-linux.yml
    with:
      ref: ${{ inputs.ref || 'llvmorg-21.1.5' }}

  macos:
    uses: ./.github/workflows/build-mlir-macos.yml
    with:
      ref: ${{ inputs.ref || 'llvmorg-21.1.5' }}

  windows:
    uses: ./.github/workflows/build-mlir-windows.yml
    with:
      ref: ${{ inputs.ref || 'llvmorg-21.1.5' }}

  release:
    needs: [linux, macos, windows]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.0
      - name: Download artifacts
        uses: actions/download-artifact@v5.0.0
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh release create test-release-2 ubuntu-24.04-archive ubuntu-24.04-arm-archive macos-15-archive macos-15-intel-archive windows-2022-archive windows-11-arm-archive --title "Test Release 2" --notes "This is a test release. It will be deleted."
